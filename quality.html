<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ApexCare â€“ Ù„ÙˆØ­Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f0f4f8;--surface:#fff;--border:#dde3ec;
  --accent:#1d4ed8;--accent-h:#1e40af;
  --success:#16a34a;--warn:#d97706;--danger:#dc2626;
  --text:#1e293b;--muted:#64748b;--radius:12px;
}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* â”€â”€ HEADER â”€â”€ */
header{background:var(--accent);color:#fff;padding:14px 24px;
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
header h1{font-size:1.15rem;font-weight:800;display:flex;align-items:center;gap:8px}
header a{color:rgba(255,255,255,.8);text-decoration:none;font-size:.82rem;
  border:1px solid rgba(255,255,255,.4);padding:6px 14px;border-radius:7px;transition:.2s}
header a:hover{background:rgba(255,255,255,.15)}

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen{
  max-width:400px;margin:60px auto 0;background:var(--surface);
  border:1px solid var(--border);border-radius:var(--radius);
  padding:40px 36px 36px;box-shadow:0 8px 32px rgba(0,0,0,.12);
  text-align:center;
}
#loginScreen .login-logo{
  width:56px;height:56px;background:var(--accent);border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.6rem;margin:0 auto 18px;
  box-shadow:0 4px 12px rgba(29,78,216,.3);
}
#loginScreen h2{font-size:1.25rem;font-weight:800;margin-bottom:5px;color:var(--text)}
#loginScreen .login-sub{font-size:.83rem;color:var(--muted);margin-bottom:28px}
.login-field{text-align:right;margin-bottom:14px}
.login-field label{
  display:block;font-size:.76rem;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px;
}
.login-input-wrap{position:relative}
.login-input-wrap input{
  width:100%;padding:11px 14px;border:1.5px solid var(--border);
  border-radius:10px;font-family:'Tajawal',sans-serif;font-size:.95rem;
  color:var(--text);background:#fff;transition:.2s;direction:rtl;
}
.login-input-wrap input:focus{
  outline:none;border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(29,78,216,.12);
}
.login-input-wrap input.field-err{border-color:var(--danger)}
.login-input-wrap input.shake{animation:shake .35s ease}
.pw-toggle{
  position:absolute;top:50%;left:12px;transform:translateY(-50%);
  background:none;border:none;cursor:pointer;color:var(--muted);
  font-size:.88rem;padding:2px 4px;line-height:1;transition:.15s;
}
.pw-toggle:hover{color:var(--accent)}
.login-input-wrap input[type=password],.login-input-wrap input[type=text]{
  padding-left:38px;
}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
#loginError{
  background:#fef2f2;border:1px solid #fca5a5;color:#991b1b;
  font-size:.82rem;border-radius:8px;padding:8px 12px;
  margin-bottom:14px;display:none;text-align:right;
}
.btn-login{
  background:var(--accent);color:#fff;width:100%;padding:12px;
  border:none;border-radius:10px;cursor:pointer;
  font-family:'Tajawal',sans-serif;font-size:.95rem;font-weight:700;
  transition:.18s;display:inline-flex;align-items:center;
  justify-content:center;gap:8px;margin-top:4px;
}
.btn-login:hover:not(:disabled){background:var(--accent-h);transform:translateY(-1px);box-shadow:0 4px 12px rgba(29,78,216,.25)}
.btn-login:disabled{opacity:.6;cursor:not-allowed}
.btn-login .login-spin{
  width:16px;height:16px;border:2px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;animation:rot .65s linear infinite;display:none;
}
@keyframes rot{to{transform:rotate(360deg)}}
.btn-login.loading .login-spin{display:block}
.btn-login.loading .login-txt{display:none}
.login-divider{
  display:flex;align-items:center;gap:10px;color:var(--muted);
  font-size:.75rem;margin:18px 0 14px;
}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.login-hint{
  background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;
  padding:8px 12px;font-size:.78rem;color:#1e40af;text-align:right;
  line-height:1.6;
}

/* â”€â”€ MAIN â”€â”€ */
#mainContent{display:block;max-width:1100px;margin:0 auto;padding:24px 16px 60px}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:20px;margin-bottom:16px;
  box-shadow:0 1px 6px rgba(0,0,0,.06)}
.card-title{font-size:.9rem;font-weight:700;color:var(--accent);
  margin-bottom:14px;padding-bottom:11px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:8px}
.card-title span{display:flex;align-items:center;gap:6px}

/* â”€â”€ FILTERS â”€â”€ */
.filter-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto auto;gap:10px;align-items:end}
.field{display:flex;flex-direction:column;gap:4px}
label{font-size:.76rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
input[type=date],input[type=number],select{
  padding:8px 12px;border:1.5px solid var(--border);border-radius:9px;
  font-family:'Tajawal',sans-serif;font-size:.9rem;color:var(--text);
  background:#fff;width:100%;transition:.2s}
input:focus,select:focus{outline:none;border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(29,78,216,.1)}

/* â”€â”€ QUICK BTNS â”€â”€ */
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:4px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;
  border-radius:9px;cursor:pointer;font-family:'Tajawal',sans-serif;font-size:.85rem;
  font-weight:700;transition:.18s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-h)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-outline{background:#fff;color:var(--accent);border:1.5px solid var(--accent)}
.btn-outline:hover{background:#eff6ff}
.btn-success{background:var(--success);color:#fff}
.btn-success:hover{background:#15803d}
/* .btn-login is defined in the LOGIN section above */

/* Spinner */
.spin{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;animation:rot .6s linear infinite;display:none}
@keyframes rot{to{transform:rotate(360deg)}}
.loading .spin{display:block}.loading .btn-txt{display:none}

/* â”€â”€ KPIs â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:10px;padding:14px 12px;
  text-align:center;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:3px 3px 0 0}
.kpi.blue::before{background:var(--accent)}
.kpi.green::before{background:var(--success)}
.kpi.yellow::before{background:var(--warn)}
.kpi.red::before{background:var(--danger)}
.kpi.gray::before{background:var(--muted)}
.kpi-lbl{font-size:.7rem;color:var(--muted);font-weight:700;text-transform:uppercase;
  letter-spacing:.4px;margin-bottom:7px}
.kpi-val{font-size:1.55rem;font-weight:800;line-height:1}
.kpi.blue   .kpi-val{color:var(--accent)}
.kpi.green  .kpi-val{color:var(--success)}
.kpi.yellow .kpi-val{color:var(--warn)}
.kpi.red    .kpi-val{color:var(--danger)}
.kpi.gray   .kpi-val{color:var(--muted)}
.kpi-sub{font-size:.72rem;color:var(--muted);margin-top:4px}

/* â”€â”€ ALERTS â”€â”€ */
.alert{display:flex;align-items:flex-start;gap:9px;padding:10px 13px;
  border-radius:9px;font-size:.86rem;margin-bottom:8px;font-weight:500}
.alert.warn{background:#fffbeb;border:1px solid #fcd34d;color:#92400e}
.alert.bad {background:#fef2f2;border:1px solid #fca5a5;color:#991b1b}
.alert.ok  {background:#f0fdf4;border:1px solid #86efac;color:#166534}

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:.83rem}
th{background:#f8fafc;color:var(--muted);padding:9px 12px;text-align:right;
  font-weight:700;font-size:.72rem;text-transform:uppercase;letter-spacing:.4px;
  border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:9px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:#f8fafc}
.badge{display:inline-block;padding:2px 9px;border-radius:99px;font-size:.75rem;font-weight:700}
.badge-y{background:#fee2e2;color:var(--danger)}.badge-n{background:#f0fdf4;color:var(--success)}
.rate-ok{color:var(--success);font-weight:700}
.rate-warn{color:var(--warn);font-weight:700}
.rate-bad{color:var(--danger);font-weight:700}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:44px 20px;color:var(--muted)}
.empty .ico{font-size:2.5rem;margin-bottom:10px}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:22px;left:50%;
  transform:translateX(-50%) translateY(70px);background:#1e293b;color:#fff;
  border-radius:10px;padding:12px 22px;font-size:.88rem;font-weight:600;
  box-shadow:0 4px 20px rgba(0,0,0,.25);z-index:999;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  max-width:340px;width:90%;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.ok {background:#166534} #toast.err{background:#991b1b}

/* â”€â”€ PROGRESS â”€â”€ */
#progressBar{height:3px;background:linear-gradient(90deg,var(--accent),#818cf8);
  border-radius:3px;display:none;margin-bottom:12px}

@media(max-width:800px){
  .filter-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:500px){
  .filter-grid{grid-template-columns:1fr}
  .kpi-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<header>
  <h1>ğŸ“Š ApexCare â€“ Ù„ÙˆØ­Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©</h1>
  <a href="supervisor.html">ğŸ“‹ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©</a>
</header>

<!-- â•â• LOGIN â•â• -->
<div id="loginScreen">
  <div class="login-logo">ğŸ“Š</div>
  <h2>ApexCare â€“ Ù„ÙˆØ­Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©</h2>
  <p class="login-sub">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©</p>

  <div id="loginError"></div>

  <!-- Username -->
  <div class="login-field">
    <label for="usernameInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
    <div class="login-input-wrap">
      <input type="text" id="usernameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
             autocomplete="username" maxlength="40" dir="rtl">
    </div>
  </div>

  <!-- Password -->
  <div class="login-field">
    <label for="keyInput">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <div class="login-input-wrap">
      <input type="password" id="keyInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
             autocomplete="current-password" maxlength="40">
      <button type="button" class="pw-toggle" id="pwToggle" title="Ø¥Ø¸Ù‡Ø§Ø± / Ø¥Ø®ÙØ§Ø¡">ğŸ‘</button>
    </div>
  </div>

  <button class="btn-login" id="loginBtn">
    <div class="login-spin"></div>
    <span class="login-txt">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
  </button>

  <div class="login-divider">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</div>
  <div class="login-hint">
    ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong>admin</strong><br>
    ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: <strong>QA-2026</strong>
  </div>
</div>

<!-- â•â• MAIN â•â• -->
<div id="mainContent" style="display:none">

  <!-- Filters -->
  <div class="card">
    <div class="card-title"><span>ğŸ” Ø§Ù„ÙÙ„Ø§ØªØ±</span></div>
    <div class="btn-row" style="margin-bottom:12px">
      <button class="btn btn-outline" onclick="setThisWeek()">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
      <button class="btn btn-outline" onclick="setThisMonth()">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
    <div class="filter-grid">
      <div class="field">
        <label>Ù…Ù†</label>
        <input type="date" id="f-start">
      </div>
      <div class="field">
        <label>Ø¥Ù„Ù‰</label>
        <input type="date" id="f-end">
      </div>
      <div class="field">
        <label>Ø§Ù„ÙØ±Ø¹</label>
        <select id="f-branch">
          <option value="all">Ø§Ù„ÙƒÙ„</option>
          <option value="Ù…Ø±ÙƒØ² Ø§Ù„Ø§ØªØµØ§Ù„">Ù…Ø±ÙƒØ² Ø§Ù„Ø§ØªØµØ§Ù„</option>
          <option value="Ø¹Ù†ÙŠØ²Ø©">Ø¹Ù†ÙŠØ²Ø©</option>
        </select>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù…ÙˆØ¸ÙØ©</label>
        <select id="f-agent"><option value="all">Ø§Ù„ÙƒÙ„</option></select>
      </div>
      <button class="btn btn-primary" id="loadBtn" onclick="loadData()">
        <div class="spin"></div>
        <span class="btn-txt">ğŸ”„ ØªØ­Ø¯ÙŠØ«</span>
      </button>
      <button class="btn btn-success" onclick="exportCSV()">ğŸ“¥ CSV</button>
    </div>
  </div>

  <!-- Progress bar -->
  <div id="progressBar"></div>

  <!-- KPIs -->
  <div class="card" id="kpiCard" style="display:none">
    <div class="card-title"><span>ğŸ¯ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</span>
      <span id="recordCount" style="font-size:.78rem;font-weight:400;color:var(--muted)"></span>
    </div>
    <div class="kpi-grid" id="kpiGrid"></div>
    <div id="alertsArea" style="margin-top:14px"></div>
  </div>

  <!-- Table -->
  <div class="card" id="tableCard" style="display:none">
    <div class="card-title"><span>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</span></div>
    <div class="tbl-wrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ø§Ù„Ù…ÙˆØ¸ÙØ©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø¬Ø§Ø¨</th><th>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø¯</th>
            <th>ØºÙŠØ± Ù…Ø¬Ø§Ø¨</th><th>Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ§ØµÙ„</th><th>Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</th>
            <th>Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„</th><th>Ù…Ø´ÙƒÙ„Ø© Ù…ÙˆØ­Ø¯</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Empty state -->
  <div id="emptyState" class="empty card">
    <div class="ico">ğŸ“Š</div>
    <p>Ø§Ø®ØªØ± Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙˆØ§Ø¶ØºØ· Â«ØªØ­Ø¯ÙŠØ«Â» Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
  </div>

</div>

<div id="toast"></div>

<!-- â•â• CONFIG â•â• -->
<script>
// â–¼â–¼â–¼ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Apps Script Web App Ù‡Ù†Ø§ â–¼â–¼â–¼
const API_URL = "https://script.google.com/macros/s/AKfycbxeZDOAj8BAP0NpQy94YzHr-GTzKE4CSwzK4ORf6SzR6VBqDIbE1FRFX64Hb4Cajs6X-g/exec";
</script>

<script>
// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Show / hide password toggle
document.getElementById("pwToggle").addEventListener("click", function () {
  const inp = document.getElementById("keyInput");
  const isHidden = inp.type === "password";
  inp.type = isHidden ? "text" : "password";
  this.textContent = isHidden ? "ğŸ™ˆ" : "ğŸ‘";
  inp.focus();
});

function showLoginError(msg) {
  const el = document.getElementById("loginError");
  el.textContent = msg;
  el.style.display = "block";
}

function hideLoginError() {
  const el = document.getElementById("loginError");
  el.style.display = "none";
  el.textContent = "";
}

function shakeField(id) {
  const inp = document.getElementById(id);
  inp.classList.add("field-err", "shake");
  setTimeout(() => inp.classList.remove("shake"), 400);
}

async function doLogin() {
  hideLoginError();

  const username = document.getElementById("usernameInput").value.trim();
  const key      = document.getElementById("keyInput").value.trim();

  // Client-side presence validation
  let hasError = false;
  if (!username) { shakeField("usernameInput"); hasError = true; }
  if (!key)      { shakeField("keyInput");      hasError = true; }
  if (hasError) { showLoginError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); return; }

  const btn = document.getElementById("loginBtn");
  btn.disabled = true;
  btn.classList.add("loading");

  try {
    const res  = await fetch(`${API_URL}?authKey=${encodeURIComponent(key)}`);
    const json = await res.json();

    if (json.ok) {
      sessionStorage.setItem("authKey", key);
      sessionStorage.setItem("authUser", username);
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      setThisWeek();
      loadAgents();
    } else {
      showLoginError("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      shakeField("keyInput");
    }
  } catch (err) {
    console.error("Login error:", err);
    showLoginError("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… â€“ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
  } finally {
    btn.disabled = false;
    btn.classList.remove("loading");
  }
}

document.getElementById("loginBtn").addEventListener("click", doLogin);

// Allow Enter key on both fields
["usernameInput", "keyInput"].forEach(id => {
  document.getElementById(id).addEventListener("keydown", e => {
    if (e.key === "Enter") doLogin();
  });
});

// Clear field-err highlight on input
["usernameInput", "keyInput"].forEach(id => {
  document.getElementById(id).addEventListener("input", () => {
    document.getElementById(id).classList.remove("field-err");
    hideLoginError();
  });
});

// â”€â”€ DATE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = d => d.toISOString().slice(0,10);

function setThisWeek() {
  const now = new Date();
  const day = now.getDay(); // 0=Sun
  const mon = new Date(now); mon.setDate(now.getDate() - ((day + 6) % 7));
  const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
  document.getElementById("f-start").value = fmt(mon);
  document.getElementById("f-end").value   = fmt(sun);
}

function setThisMonth() {
  const now = new Date();
  document.getElementById("f-start").value = fmt(new Date(now.getFullYear(), now.getMonth(), 1));
  document.getElementById("f-end").value   = fmt(new Date(now.getFullYear(), now.getMonth() + 1, 0));
}

// â”€â”€ LOAD AGENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAgents() {
  const authKey = sessionStorage.getItem("authKey") || "";
  try {
    const res  = await fetch(`${API_URL}?authKey=${encodeURIComponent(authKey)}&start=2020-01-01&end=2099-12-31`);
    const json = await res.json();
    if (!json.ok) return;
    const sel = document.getElementById("f-agent");
    sel.innerHTML = '<option value="all">Ø§Ù„ÙƒÙ„</option>';
    (json.agents || []).forEach(a => {
      const o = document.createElement("option");
      o.value = a; o.textContent = esc(a);
      sel.appendChild(o);
    });
  } catch(e) {}
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentRows = [];

async function loadData() {
  const authKey = sessionStorage.getItem("authKey") || "";
  const start   = document.getElementById("f-start").value;
  const end     = document.getElementById("f-end").value;
  const branch  = document.getElementById("f-branch").value;
  const agent   = document.getElementById("f-agent").value;

  if (!start || !end) { showToast("Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®", "warn"); return; }
  if (start > end)    { showToast("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø¨Ù‚ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", "warn"); return; }

  const btn = document.getElementById("loadBtn");
  btn.disabled = true; btn.classList.add("loading");
  showProgress(true);

  let url = `${API_URL}?authKey=${encodeURIComponent(authKey)}&start=${start}&end=${end}`;
  if (branch !== "all") url += `&branch=${encodeURIComponent(branch)}`;
  if (agent  !== "all") url += `&agent=${encodeURIComponent(agent)}`;

  try {
    const res  = await fetch(url);
    const json = await res.json();

    if (!json.ok) {
      showToast("âŒ " + (json.error || "Ø®Ø·Ø£"), "err");
      return;
    }

    currentRows = json.rows || [];
    renderDashboard(currentRows);

  } catch (err) {
    showToast("âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€“ ØªØ­Ù‚Ù‚ Ù…Ù† API_URL", "err");
    console.error(err);
  } finally {
    btn.disabled = false; btn.classList.remove("loading");
    showProgress(false);
  }
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(rows) {
  if (!rows.length) {
    document.getElementById("kpiCard").style.display    = "none";
    document.getElementById("tableCard").style.display  = "none";
    document.getElementById("emptyState").style.display = "block";
    document.getElementById("emptyState").querySelector("p").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©";
    return;
  }
  document.getElementById("emptyState").style.display = "none";
  document.getElementById("kpiCard").style.display    = "block";
  document.getElementById("tableCard").style.display  = "block";

  // Aggregate
  const sumOf  = k => rows.reduce((a,r) => a + (+(r[k]||0)), 0);
  const total  = sumOf("TotalCalls");
  const ans    = sumOf("AnsweredCalls");
  const unansCnt = sumOf("UnansweredEOD");
  const cbDone = sumOf("CallbacksCompleted");
  const cbMins = sumOf("CallbackTimeMinutes");
  const n      = rows.length;

  const rate      = total > 0 ? ans / total * 100 : 0;
  const unansPct  = total > 0 ? unansCnt / total * 100 : 0;
  const cbEff     = unansCnt > 0 ? Math.min(100, cbDone / unansCnt * 100) : 100;
  const avgMins   = cbDone  > 0 ? cbMins / cbDone : 0;
  const daysCallI = rows.filter(r => r.CallIssues === "Yes").length;
  const daysUniI  = rows.filter(r => r.UnifiedNumberIssues === "Yes").length;

  const rC  = rate >= 90 ? "green" : rate >= 85 ? "yellow" : "red";
  const uC  = unansPct <= 5 ? "green" : unansPct <= 15 ? "yellow" : "red";
  const cbC = cbEff >= 85 ? "green" : cbEff >= 70 ? "yellow" : "red";

  document.getElementById("recordCount").textContent = `${n} Ø³Ø¬Ù„`;
  document.getElementById("kpiGrid").innerHTML = `
    <div class="kpi blue"><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</div><div class="kpi-val">${total.toLocaleString("ar")}</div></div>
    <div class="kpi blue"><div class="kpi-lbl">Ø§Ù„Ù…Ø¬Ø§Ø¨ Ø¹Ù„ÙŠÙ‡Ø§</div><div class="kpi-val">${ans.toLocaleString("ar")}</div></div>
    <div class="kpi ${rC}"><div class="kpi-lbl">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø¯</div><div class="kpi-val">${rate.toFixed(1)}%</div><div class="kpi-sub">Ø§Ù„Ù‡Ø¯Ù â‰¥ 90%</div></div>
    <div class="kpi ${uC}"><div class="kpi-lbl">ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨</div><div class="kpi-val">${unansCnt.toLocaleString("ar")}</div><div class="kpi-sub">${unansPct.toFixed(1)}%</div></div>
    <div class="kpi ${cbC}"><div class="kpi-lbl">ÙƒÙØ§Ø¡Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</div><div class="kpi-val">${cbEff.toFixed(0)}%</div></div>
    <div class="kpi blue"><div class="kpi-lbl">Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ§ØµÙ„</div><div class="kpi-val">${cbDone.toLocaleString("ar")}</div></div>
    <div class="kpi gray"><div class="kpi-lbl">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</div><div class="kpi-val">${cbMins.toLocaleString("ar")}</div></div>
    <div class="kpi gray"><div class="kpi-lbl">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</div><div class="kpi-val">${avgMins.toFixed(1)}</div><div class="kpi-sub">Ù„ÙƒÙ„ Ø±Ø¯</div></div>
    <div class="kpi ${daysCallI > 0 ? "red" : "green"}"><div class="kpi-lbl">Ø£ÙŠØ§Ù… Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„</div><div class="kpi-val">${daysCallI}</div></div>
    <div class="kpi ${daysUniI  > 0 ? "red" : "green"}"><div class="kpi-lbl">Ø£ÙŠØ§Ù… Ù…Ø´ÙƒÙ„Ø© Ù…ÙˆØ­Ø¯</div><div class="kpi-val">${daysUniI}</div></div>
    <div class="kpi blue"><div class="kpi-lbl">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div><div class="kpi-val">${n}</div></div>
  `;

  // Alerts
  const alerts = [];
  if (rate < 85)       alerts.push({t:"bad",  m:`ğŸš¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø¯ ${rate.toFixed(1)}% â€“ Ø£Ù‚Ù„ Ù…Ù† 85%ØŒ ÙŠØªØ·Ù„Ø¨ ØªØ¯Ø®Ù„Ø§Ù‹ ÙÙˆØ±ÙŠØ§Ù‹`});
  else if (rate < 90)  alerts.push({t:"warn", m:`âš ï¸ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø¯ ${rate.toFixed(1)}% â€“ Ø¯ÙˆÙ† 90%`});
  else                 alerts.push({t:"ok",   m:`âœ… Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø¯ Ù…Ù…ØªØ§Ø²: ${rate.toFixed(1)}%`});
  if (unansPct > 5)    alerts.push({t:"warn", m:`ğŸ“µ Ù†Ø³Ø¨Ø© ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨ ${unansPct.toFixed(1)}% â€“ ØªØ¬Ø§ÙˆØ²Øª 5%`});
  if (daysCallI > 0)   alerts.push({t:"warn", m:`ğŸ”´ ${daysCallI} ÙŠÙˆÙ… Ø¨Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„Ø§Øª Ù…ÙØ³Ø¬ÙÙ‘Ù„Ø©`});
  if (daysUniI  > 0)   alerts.push({t:"warn", m:`ğŸ“ ${daysUniI} ÙŠÙˆÙ… Ø¨Ù…Ø´ÙƒÙ„Ø© Ø±Ù‚Ù… Ù…ÙˆØ­Ø¯`});

  document.getElementById("alertsArea").innerHTML = alerts.map(a =>
    `<div class="alert ${a.t}">${esc(a.m)}</div>`
  ).join("");

  // Table
  document.getElementById("tableBody").innerHTML = rows.map(r => {
    const tc = +(r.TotalCalls||0), ac = +(r.AnsweredCalls||0);
    const rt = tc > 0 ? (ac/tc*100).toFixed(1)+"%" : "â€”";
    const rc = tc > 0 ? (ac/tc >= .9 ? "rate-ok" : ac/tc >= .85 ? "rate-warn" : "rate-bad") : "";
    return `<tr>
      <td>${esc(String(r.Date||""))}</td>
      <td>${esc(r.Branch||"")}</td>
      <td style="font-weight:600">${esc(r.AgentName||"")}</td>
      <td>${tc}</td><td>${ac}</td>
      <td class="${rc}">${rt}</td>
      <td>${+(r.UnansweredEOD||0)}</td>
      <td>${+(r.CallbacksCompleted||0)}</td>
      <td>${+(r.CallbackTimeMinutes||0)}</td>
      <td><span class="badge ${r.CallIssues==="Yes"?"badge-y":"badge-n"}">${r.CallIssues==="Yes"?"Ù†Ø¹Ù…":"Ù„Ø§"}</span></td>
      <td><span class="badge ${r.UnifiedNumberIssues==="Yes"?"badge-y":"badge-n"}">${r.UnifiedNumberIssues==="Yes"?"Ù†Ø¹Ù…":"Ù„Ø§"}</span></td>
    </tr>`;
  }).join("");
}

// â”€â”€ EXPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  if (!currentRows.length) { showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±", "warn"); return; }
  const hdrs = ["Date","Branch","AgentName","TotalCalls","AnsweredCalls",
                "UnansweredEOD","CallbacksCompleted","CallbackTimeMinutes",
                "CallIssues","UnifiedNumberIssues"];
  const csvHdrs = ["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„ÙØ±Ø¹","Ø§Ù„Ù…ÙˆØ¸ÙØ©","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Ø§Ù„Ù…Ø¬Ø§Ø¨",
                   "ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨","Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ§ØµÙ„","Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚","Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„","Ù…Ø´ÙƒÙ„Ø© Ù…ÙˆØ­Ø¯"];

  let csv = "\uFEFF" + csvHdrs.join(",") + "\n"; // BOM for Excel Arabic
  currentRows.forEach(r => {
    csv += hdrs.map(k => `"${String(r[k]||"").replace(/"/g,'""')}"`).join(",") + "\n";
  });

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = `quality-report-${document.getElementById("f-start").value}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { const d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

function showProgress(on) {
  const bar = document.getElementById("progressBar");
  bar.style.display = on ? "block" : "none";
  bar.style.width   = on ? "0" : "100%";
  if (on) setTimeout(() => { bar.style.width="75%"; }, 40);
}

function showToast(msg, type) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = type === "ok" ? "ok" : "";
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 4000);
}
</script>
</body>
</html>
